# Обзор сущности «многостраничные продукты»

Документ описывает, как в системе представлены многостраничные изделия (буклеты, брошюры, каталоги и т.п.) и где они используются.

---

## 1. Типы сущностей

В коде фигурируют **два разных понятия**, которые легко спутать:

| Термин | Где используется | Суть |
|--------|-------------------|------|
| **`product_type = 'multi_page'`** | Таблица `products`, API продуктов, калькулятор | Тип **продукта в каталоге**: «это многостраничное изделие». У такого продукта обычно `calculator_type = 'simplified'`, параметр `pages` и т.д. |
| **`multipage` (схема/API)** | `product_schemas.json`, `/pricing/multipage/*` | Отдельный **конструктор расчёта** из JSON-схемы: страницы, формат, тип печати, переплёт, бумага. Используется формой `MultiPageProductForm` и сервисом `MultipageProductService`. |

То есть:
- **multi_page** — признак продукта в БД и в логике калькулятора (simplified/flexible pricing).
- **multipage** — отдельный сценарий расчёта со своей схемой и API (`/pricing/multipage/calculate`, `/multipage/schema`, `/multipage/binding-types`).

---

## 2. Где что лежит

### Backend

- **Схема и расчёт «multipage»**
  - `backend/src/data/product_schemas.json` — секция `schemas.multipage`: поля (pages, format, printType, bindingType, paperType, paperDensity, duplex, lamination, trimMargins), правила переплёта (`bindingRules`), дефолтные цены.
  - `backend/src/modules/pricing/services/multipageProductService.ts` — класс `MultipageProductService`:
    - `calculate()` — стоимость по параметрам (печать, переплёт, бумага, ламинация, обрезка);
    - цены печати/переплёта подтягиваются из `post_processing_services` или из дефолтов схемы;
    - `getBindingTypes()` — типы переплёта с ограничениями по страницам;
    - `getSchema()` — отдаёт схему из JSON.
  - Роуты в `backend/src/routes/pricing.ts`:
    - `POST /pricing/multipage/calculate` — расчёт;
    - `GET /pricing/multipage/schema` — схема для UI;
    - `GET /pricing/multipage/binding-types` — типы переплёта.

- **Продукты с типом multi_page**
  - Таблица `products`: колонка `product_type` (CHECK: `'sheet_single' | 'multi_page' | 'universal' | 'sheet_item' | 'multi_page_item'`).
  - При создании продукта с `product_type === 'multi_page'` автоматически выставляется `calculator_type = 'simplified'` (`backend/src/modules/products/routes/products.ts`: POST и PUT).
  - Схема продукта (GET `/products/:id/schema`): если в `template.config.simplified.pages` заданы `options`, в схему добавляется/обновляется поле `pages` с enum из этих опций.

- **Расчёт цен для multi_page в основной системе**
  - `simplifiedPricingService.ts`: для продукта с `product_type === 'multi_page'` используется множитель по страницам (`usePagesMultiplier`, `effectivePages`, листы = ceil(pages/2) при duplex).
  - `flexiblePricingService.ts`: маппинг названий продуктов в тип; буклеты/каталоги/брошюры и т.д. → `'multi_page'`.
  - `unifiedPricingService` / контроллер ценообразования могут подставлять `productType: 'multi_page'` при расчёте.

### Frontend

- **Редактор «многостраничных» цен (глобальная схема)**
  - Страница `/products/multipage` — `MultiPageProductEditor.tsx`: вкладки «Переплёт», «Печать», «Бумага», «Превью». Загружает `GET /pricing/multipage/schema`, правит, по сути, глобальные настройки/подсказки для сценария multipage (редактор не сохраняет в БД продукт; если сохраняет — нужно уточнить куда).

- **Калькулятор «multipage» (форма по схеме из API)**
  - `MultiPageProductForm.tsx` — форма: страницы, тираж, формат, тип печати, переплёт, материал, опции. Вызывает `POST /pricing/multipage/calculate`, показывает итог и breakdown.
  - `useMultiPageCalculation.ts` — загрузка схемы (`/pricing/multipage/schema`), вызов расчёта (`/pricing/multipage/calculate`).

- **Обычный калькулятор и продукты multi_page**
  - В `ImprovedPrintingCalculatorModal` для продуктов из каталога используется упрощённая/гибкая схема (specs: productType, quantity, **pages** и т.д.), а не обязательно форма `MultiPageProductForm`.
  - Тип продукта `multi_page` из каталога ведёт к `calculator_type = 'simplified'` и к расчёту через simplified/flexible pricing с учётом страниц.

- **Шаблоны и конфиг многостраничных**
  - `SimplifiedTemplateSection.tsx`: блок «Страницы (для многостраничных изделий)» — конфиг `simplified.pages` (options, default). Это как раз те опции, которые подставляются в схему продукта при GET `/products/:id/schema`.
  - Пресеты параметров для `multi_page` в миграциях (например `product_parameter_presets`: pages, format, binding, print_method и т.д.).

---

## 3. Два сценария расчёта

1. **Через «multipage» API**  
   Пользователь открывает форму, привязанную к схеме из `product_schemas.json` (страницы, переплёт, тип печати и т.д.). Расчёт идёт в `MultipageProductService` и не привязан к конкретному продукту из каталога. Используется на странице редактора и в форме `MultiPageProductForm`.

2. **Через продукт каталога с типом multi_page**  
   Пользователь выбирает продукт (например «Буклеты») с `product_type = 'multi_page'` и `calculator_type = 'simplified'`. Схема и параметры (в т.ч. `pages`) берутся из конфига этого продукта (template, simplified, параметры). Расчёт идёт через `SimplifiedPricingService` / гибкий расчёт, с учётом страниц и листов.

Связь между этими сценариями не жёсткая: «multipage» — отдельный конструктор; продукты multi_page — каталог с упрощённым калькулятором. Они могут давать разные результаты и разные поля в UI.

---

## 4. Несогласованности и риски

- **Дублирование логики**: переплёт, типы печати, ограничения по страницам заданы и в `product_schemas.json`, и в пресетах/конфиге продуктов, и в коде сервисов. Изменение в одном месте не автоматически отражается в другом.
- **Два входа для «многостраничного»**: один — выбор продукта типа multi_page в калькуляторе (схема продукта), второй — форма/страница, завязанная на `/pricing/multipage/*`. Пользователь может не понимать разницу.
- **Редактор `/products/multipage`**: непрозрачно, куда сохраняются изменения (только ли в JSON/память или в БД). Если это правка глобальной схемы — она не в продуктах; если правка продукта — неочевидно, какого.
- **Типы переплёта**: в `MultipageProductService` маппинг имён услуг переплёта из БД захардкожен (лазер/цифра/офсет, пружина/скоба и т.д.). Добавление новой услуги в админке может не попасть в расчёт без правки кода.

---

## 5. Рекомендации по пересмотру

1. **Определиться с единственным источником правды**  
   Либо «многостраничный» расчёт всегда идёт через продукты каталога (multi_page + simplified), и тогда схема/правила хранятся в конфиге продукта и общих справочниках (услуги, материалы). Либо сохраняется отдельный сценарий multipage — тогда явно описать, для каких кейсов он используется и как связан с продуктами (например, один «виртуальный» продукт «Многостраничная продукция» с привязкой к этому сценарию).

2. **Свести к одному сценарию в UI**  
   Или калькулятор всегда работает только с продуктами из каталога (в т.ч. multi_page), или одна явная точка входа «Многостраничная продукция» с одной формой и одним API. Избегать двух параллельных форм с разной логикой.

3. **Переплёт и печать**  
   Цены и типы переплёта/печати брать из `post_processing_services` и категорий послепечатных услуг, с явным маппингом по коду/типу операции (например `operation_type = 'bind'`) и по названию/категории, без большого хардкода в `multipageProductService`.

4. **Документировать и упростить**  
   В админке и в коде явно разделить: «продукт каталога типа multi_page» и «конструктор multipage» (если он остаётся). Обновить документацию по созданию продуктов и по калькулятору, чтобы было понятно, когда что используется.

5. **Редактор `/products/multipage`**  
   Либо привязать к одному конкретному продукту (например «Многостраничная продукция») и сохранять в его template/config, либо переименовать в «Настройки глобальной схемы многостраничных» и хранить в одном месте (например конфиг в БД или тот же JSON), с ясным описанием в UI.

---

## 6. Краткая схема (как сейчас)

```
[ product_schemas.json: schemas.multipage ]
         │
         ▼
  MultipageProductService  ◄── GET /pricing/multipage/schema
         │                      POST /pricing/multipage/calculate
         │                      GET /pricing/multipage/binding-types
         │
         ├──► MultiPageProductEditor (страница /products/multipage)
         └──► MultiPageProductForm + useMultiPageCalculation (форма в калькуляторе?)

[ products.product_type = 'multi_page' ]
         │
         ▼
  calculator_type = 'simplified'  (принудительно при создании/обновлении)
         │
         ▼
  GET /products/:id/schema  ──►  simplified.pages.options → поле "pages"
         │
         ▼
  SimplifiedPricingService (usePagesMultiplier, effectivePages, листы)
  FlexiblePricingService   (маппинг названия → multi_page)
```

Итого: сущность «многостраничные продукты» сейчас раздвоена на **тип продукта в каталоге** (`multi_page` + simplified) и **отдельный конструктор** (схема multipage + MultipageProductService). Пересмотр лучше начать с решения: один сценарий или два, и кто главный источник правил и цен — продукт или глобальная схема.

---

## 7. Принятый подход: только продукты каталога

**Решение:** многостраничные изделия настраиваются **только как отдельные продукты в каталоге**. Один продукт = один вариант переплёта/набора операций (например «Фотоальбом на две скобы», «Фотоальбом на пружине»).

- В каталоге создаётся продукт с типом **Многостраничный** (`product_type = 'multi_page'`).
- У продукта задаются: название, категория (например «Фотоальбомы»), шаблон с параметрами (страницы, формат и т.д.), **свой набор операций** (печать, переплёт, резка и т.д.), материалы.
- В калькуляторе пользователь выбирает **конкретный продукт** (например «Фотоальбом на скобах») и получает форму и расчёт по схеме этого продукта.
- Глобальный конструктор (`/pricing/multipage/*`, страница «Настройки многостраничных») остаётся **справочным** (или для совместимости), но основным способом добавления многостраничных позиций является создание и настройка продуктов в каталоге.

---

## 8. Что будет дальше при создании многостраничного продукта

1. **Создание продукта**  
   В каталоге продуктов нажимаете «Создать продукт», выбираете тип **«Многостраничное»**. Тип калькулятора автоматически ставится «Упрощённый». Заполняете название, категорию (например «Фотоальбомы»), при необходимости описание и процент оператора. Нажимаете «Создать продукт».

2. **Переход на шаблон**  
   После создания происходит переход на страницу **шаблона продукта** (`/adminpanel/products/:id/template`). Для многостраничного показывается блок **«Упрощённый калькулятор»**.

3. **Настройка шаблона (что делать дальше)**  
   - **Страницы** — в блоке «Страницы (для многостраничных изделий)» укажите варианты через запятую (например `4, 8, 12, 16, 20, 24`) и значение по умолчанию. Они появятся в калькуляторе в поле «Страницы».  
   - **Размеры** — нажмите «Добавить размер», задайте обрезной формат (например A5, 148×210). Можно добавить несколько размеров.  
   - **Для каждого размера** настройте: цены печати (по технологиям/тиражам), разрешённые материалы и плотности, отделку (резка, биговка, фальцовка и т.д.).  
   - Нажмите **«Сохранить»** в шаблоне — конфигурация сохранится.

4. **Итог**  
   Продукт с типом «Многостраничный» и сохранённым шаблоном появляется в калькуляторе. Клиент выбирает этот продукт, указывает количество страниц (из заданных вариантов), размер, тираж и остальные параметры — расчёт идёт по упрощённой модели (SimplifiedPricingService) с учётом страниц и листов.

Если нужно **другой переплёт или другой набор операций** (например фотоальбом на пружине вместо скобы) — создаёте **второй продукт** с типом «Многостраничное» и настраиваете у него свой шаблон и свои операции.

---

## 9. Как многостраничный шаблон считает стоимость

Расчёт ведёт **SimplifiedPricingService** (бэкенд). Итоговая цена складывается из трёх частей: **печать** + **материал** + **отделка**. Для многостраничного продукта количество **страниц** и режим **одно-/двухсторонней печати** влияют на то, сколько «листов» считается на одно изделие и на весь заказ.

### Исходные данные из калькулятора

- **Тираж** (quantity) — число изделий, например 10 альбомов.
- **Страницы** (pages) — число страниц в одном изделии, например 24.
- **Режим печати** (print_sides_mode): односторонняя (`single`), двухсторонняя (`duplex` / `duplex_bw_back`).
- **Размер** (size_id) — выбранный обрезной формат из шаблона.
- **Печать** — технология и цвет (Ч/Б, цвет).
- **Материал** — выбранная бумага из разрешённых для размера.
- **Отделка** — список услуг (переплёт, резка, ламинация и т.д.) с указанием, за что считается цена: за рез/операцию или за изделие.

### Как считается «объём печати»

Только для продуктов с **product_type = 'multi_page'**:

1. **Листов на одно изделие** (sheetsPerItem):
   - при **двухсторонней** печати: `листов = ceil(страницы / 2)` (например 24 стр. → 12 листов);
   - при **односторонней**: `листов = страницы` (24 стр. → 24 листа).

2. **Эффективный объём печати** (effectivePrintQuantity) — во сколько «листов» считается весь тираж:
   - `effectivePrintQuantity = тираж × листов_на_изделие`  
   - Пример: 10 шт. × 12 листов = 120 листов.

Этот объём используется **только для печати и материала**: по нему выбирается диапазон тиража (tier) и считается сумма.

### Формулы по компонентам

- **Печать**  
  В шаблоне у размера заданы **print_prices** (технология, цвет, сторона) и для каждого — **диапазоны тиража** (tiers) с ценой за лист.  
  По `effectivePrintQuantity` выбирается подходящий tier, берётся **цена за лист** (unit_price).  
  **Стоимость печати = цена за лист × effectivePrintQuantity.**

- **Материал**  
  У размера заданы **material_prices** (по материалам) с диапазонами тиража и ценой за лист.  
  По `effectivePrintQuantity` выбирается tier, берётся цена за лист.  
  **Стоимость материала = цена за лист × effectivePrintQuantity.**

- **Отделка**  
  В шаблоне у размера заданы услуги (**finishing**): service_id, **price_unit** (`per_cut` или `per_item`), **units_per_item**.  
  Реальные цены и диапазоны тиража берутся из **централизованных услуг** (post_processing_services, service_volume_prices), а не из шаблона.  
  - **per_cut** (за рез/операцию): количество операций = тираж × units_per_item; стоимость = цена за единицу × количество операций.  
  - **per_item** (за изделие/заказ): считается по units_per_item и тиражу по правилам услуги (например ламинация: за изделие × тираж).

### Итог

- **subtotal = печать + материал + отделка**
- **finalPrice = subtotal** (в упрощённом калькуляторе доп. наценки не применяются)
- **Цена за изделие = finalPrice / тираж**

Таким образом, многостраничный шаблон просчитывает стоимость так: страницы и двухсторонняя печать уменьшают число листов на изделие; печать и материал считаются по «объёму в листах» (effectivePrintQuantity); отделка — по тиражу и правилам каждой операции (за рез или за изделие).
