# Гибкая система калькуляторов полиграфии

## Обзор

Система позволяет создавать продукты из базовых операций через админку **без хардкода**. Все цены, услуги и правила хранятся в БД.

## Архитектура

```
Продукт = Материалы + Операции + Правила ценообразования
```

### Ключевые таблицы

1. **`post_processing_services`** — расширена для всех типов операций:
   - `operation_type`: print, cut, fold, laminate, score, etc.
   - `price_unit`: per_sheet, per_item, per_m2, fixed
   - `setup_cost`: стоимость приладки/настройки
   - `min_quantity`: минимальный тираж
   - `parameters`: JSON с параметрами операции

2. **`product_operations_link`** — связь продукт→операции:
   - `product_id` + `operation_id`
   - `sequence`: порядок выполнения
   - `is_required`: обязательная операция
   - `price_multiplier`: корректировка цены для конкретного продукта
   - `conditions`: JSON условия применения

3. **`operation_pricing_rules`** — правила ценообразования:
   - `rule_type`: quantity_discount, size_based, material_based, rush
   - `conditions`: JSON условия (мин. тираж, размер, и т.п.)
   - `pricing_data`: JSON данные (скидка %, множитель)

4. **`products`**, **`product_parameters`** — продукты и их параметры
5. **`materials`**, **`product_materials_new`** — материалы и их связь с продуктами

## Типы операций

| Тип | Описание | Единица | Примеры |
|-----|----------|---------|---------|
| `print` | Печать | per_sheet | Цифровая печать CMYK, ч/б |
| `cut` | Резка | per_sheet, per_item | Гильотина, скругление углов |
| `fold` | Фальцовка | per_item | 1 сгиб, 2 сгиба |
| `score` | Биговка | per_item | Для плотных материалов |
| `laminate` | Ламинация | per_sheet | Глянцевая, матовая |
| `bind` | Переплет | per_item | Скоба, пружина, клей |
| `perforate` | Перфорация | per_item | Отрывная линия |
| `emboss` | Тиснение | per_item | Конгрев |
| `foil` | Фольгирование | per_item | Золото, серебро |
| `design` | Дизайн | fixed | Разработка макета |
| `other` | Прочее | any | Проверка макета, упаковка |

## Единицы измерения

- **`per_sheet`** — за лист (печать, ламинация)
- **`per_item`** — за изделие (резка, фальцовка)
- **`per_m2`** — за м² (широкоформатная печать)
- **`per_hour`** — за час работы (сложные операции)
- **`fixed`** — фиксированная стоимость (дизайн, проверка)

## Правила ценообразования

### 1. Скидка от тиража (`quantity_discount`)
```json
{
  "conditions": {"min_quantity": 500},
  "pricing_data": {"discount_percent": 10}
}
```

### 2. От размера (`size_based`)
```json
{
  "conditions": {"min_width": 100, "min_height": 100},
  "pricing_data": {"price_per_m2": 5.0}
}
```

### 3. От материала (`material_based`)
```json
{
  "conditions": {"material_category": "Бумага"},
  "pricing_data": {
    "material_multipliers": {
      "20": 1.2,  // ID материала → множитель
      "21": 1.5
    }
  }
}
```

### 4. За срочность (`rush`)
```json
{
  "conditions": {"is_rush": true},
  "pricing_data": {"rush_multiplier": 1.5}
}
```

## Пример: Визитки стандартные

### Операции для продукта "Визитки 90x50"

1. **Печать цифровая** (обязательно)
   - Тип: `print`
   - Единица: `per_sheet`
   - Цена: 0.15 BYN/лист
   - Приладка: 0 BYN
   - Параметры: `{"color_mode": "cmyk", "sides": [1, 2]}`

2. **Резка** (обязательно)
   - Тип: `cut`
   - Единица: `per_sheet`
   - Цена: 0.01 BYN/лист
   - Приладка: 5 BYN
   - Параметры: `{"accuracy": "+/- 1mm"}`

3. **Ламинация** (опционально)
   - Тип: `laminate`
   - Единица: `per_sheet`
   - Цена: 0.25 BYN/лист
   - Приладка: 10 BYN
   - Условие: `{"lamination": true}`

4. **Скругление углов** (опционально)
   - Тип: `cut`
   - Единица: `per_item`
   - Цена: 0.02 BYN/шт
   - Приладка: 5 BYN
   - Условие: `{"corner_rounding": true}`

### Материалы

- **Бумага мелованная 350г** — 0.40 BYN/лист
- **Пленка ламинационная** — включена в стоимость операции

### Расчет для 100 визиток (90x50)

1. **Раскладка**: 10 визиток на лист SRA3 (320x450) = 10 листов
2. **Печать**: 10 листов × 0.15 = 1.50 BYN
3. **Материал**: 10 листов × 0.40 = 4.00 BYN
4. **Резка**: 10 листов × 0.01 + 5 (приладка) = 5.10 BYN
5. **Итого себестоимость**: 10.60 BYN
6. **Наценка 2.2×**: 23.32 BYN
7. **Цена за визитку**: 0.23 BYN

## API для управления

### Операции

```typescript
// Получить все операции
GET /api/operations

// Создать операцию
POST /api/operations
{
  "name": "Цифровая печать A4",
  "operation_type": "print",
  "price": 0.10,
  "price_unit": "per_sheet",
  "setup_cost": 0,
  "parameters": {"color_mode": "cmyk"}
}

// Обновить операцию
PUT /api/operations/:id
{
  "price": 0.12
}
```

### Связь продукт→операции

```typescript
// Добавить операцию к продукту
POST /api/products/:productId/operations
{
  "operation_id": 1,
  "sequence": 1,
  "is_required": true,
  "price_multiplier": 1.0
}

// Получить операции продукта
GET /api/products/:productId/operations
```

### Правила ценообразования

```typescript
// Добавить правило к операции
POST /api/operations/:operationId/pricing-rules
{
  "rule_name": "Скидка от тиража",
  "rule_type": "quantity_discount",
  "conditions": {"min_quantity": 500},
  "pricing_data": {"discount_percent": 10}
}
```

## Алгоритм расчета

1. **Получить продукт** и его операции (по `sequence`)
2. **Проверить условия** применения каждой операции (`conditions`)
3. **Рассчитать количество** (листов/изделий/м²) с учетом раскладки
4. **Для каждой операции**:
   - Базовая цена × множитель продукта
   - Применить правила ценообразования (скидки, надбавки)
   - Рассчитать: `(количество × цена_за_единицу) + приладка`
5. **Рассчитать материалы** из `product_materials_new`
6. **Итог**: материалы + операции + наценка - скидка за тираж

## Преимущества

✅ **Без хардкода** — все в БД  
✅ **Гибкость** — новые продукты через админку  
✅ **Переиспользование** — операции общие для многих продуктов  
✅ **Динамическое ценообразование** — правила применяются автоматически  
✅ **Аудит** — история изменений цен и операций  
✅ **Масштабируемость** — легко добавлять новые типы операций  

## Примеры сложных продуктов

### Буклеты А4, 2 фальца
- Печать (A3, 2 стороны)
- Фальцовка (2 сгиба)
- Резка

### Листовки с ламинацией
- Печать (A3, 1 сторона)
- Ламинация (глянец)
- Резка

### Визитки на пластике
- Печать УФ (специальная операция)
- Резка
- Скругление

## Интеграция с фронтендом

Фронтенд получает:
1. Список продуктов (`GET /api/products`)
2. Параметры продукта (`GET /api/products/:id`)
3. Доступные операции для продукта (`GET /api/products/:id/operations`)
4. Рассчитанную цену (`POST /api/products/:id/calculate`)

Пример запроса:
```json
POST /api/products/1/calculate
{
  "quantity": 100,
  "parameters": {
    "width": 90,
    "height": 50,
    "sides": 2,
    "lamination": true,
    "corner_rounding": false
  }
}
```

Ответ:
```json
{
  "product_id": 1,
  "quantity": 100,
  "operations": [
    {
      "operation_code": "digital_color_print",
      "operation_name": "Цифровая цветная печать",
      "unit_price": 0.15,
      "quantity": 10,
      "setup_cost": 0,
      "total": 1.50
    },
    {
      "operation_code": "cutting",
      "operation_name": "Резка",
      "unit_price": 0.01,
      "quantity": 10,
      "setup_cost": 5,
      "total": 5.10
    }
  ],
  "material_cost": 4.00,
  "operations_cost": 6.60,
  "setup_costs": 5.00,
  "subtotal": 10.60,
  "markup": 2.2,
  "discount_percent": 0,
  "discount_amount": 0,
  "final_price": 23.32,
  "price_per_unit": 0.23
}
```

## Дальнейшее развитие

- [ ] Админка для управления операциями
- [ ] Визуальный редактор композиции продуктов
- [ ] Автоматические правила ценообразования на основе истории
- [ ] AI-предиктор цен
- [ ] Интеграция с внешними поставщиками
- [ ] Мобильное приложение для расчета

---

**Статус**: ✅ Базовая система реализована  
**Миграция**: `20250202000001_add_flexible_operations.ts`  
**Дата**: 2025-02-02

