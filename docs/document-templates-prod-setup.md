# Настройка шаблонов документов на проде (DOCUMENT_TEMPLATES_DIR)

После деплоя файлы шаблонов (акт, счёт), сохранённые внутри контейнера в `dist/templates/`, пропадают. Чтобы шаблоны переживали перезапуск и пересборку, их нужно хранить в постоянной папке и подключать к приложению через переменную окружения и volume.

---

## 1. Что делает DOCUMENT_TEMPLATES_DIR

- **При загрузке шаблона** (через UI): файл сохраняется в каталог `DOCUMENT_TEMPLATES_DIR` (если переменная задана), иначе — в `backend/templates` относительно приложения (в Docker это обычно теряется при пересборке).
- **При генерации акта/счёта**: путь к файлу берётся так:
  - если задан `DOCUMENT_TEMPLATES_DIR` и в нём есть файл с именем из БД (например `act-1769783861347.xlsx`) — используется он;
  - иначе — путь из БД (после деплоя он часто уже не существует).

Имена файлов в БД у вас: `act-1769783861347.xlsx`, `invoice-1769783876176.xlsx` (из логов).

---

## 2. Где крутится бэкенд

В репозитории есть только один Dockerfile — он собирает и отдаёт **фронт** (serve на 5173). Бэкенд вы, скорее всего, запускаете отдельно: свой Dockerfile/образ, docker-compose или процесс на хосте.

Дальнейшие шаги зависят от того, как именно запущен бэкенд.

---

## 3. Вариант A: Бэкенд в Docker (docker run или docker-compose)

### 3.1. Постоянная папка для шаблонов

Нужна директория, которая не удаляется при пересоздании контейнера:

- либо **папка на хосте**, которую вы монтируете в контейнер;
- либо **named volume** Docker.

Пример папки на хосте: `/home/deploy/crm-templates` (Linux) или `C:\crm\templates` (Windows). Имя и путь могут быть любыми.

### 3.2. Положить файлы шаблонов

Скопируйте в эту папку файлы с **теми же именами**, что записаны в БД:

- `act-1769783861347.xlsx`
- `invoice-1769783876176.xlsx`

Откуда взять: с другой машины, где они ещё есть, из бэкапа или заново экспортировать из CRM (если есть доступ к скачиванию шаблона до перезапуска). Имена должны совпадать с путями в таблице `document_templates` (колонка `file_path` — там полный путь, но при поиске используется только имя файла).

### 3.3. Переменная окружения

В среде запуска контейнера с бэкендом задайте путь **внутри контейнера**, по которому будет доступна эта папка (после монтирования):

```bash
DOCUMENT_TEMPLATES_DIR=/data/document-templates
```

Можно выбрать другой путь, например `/app/templates` — главное, чтобы он совпадал с точкой монтирования (см. ниже).

### 3.4. Монтирование папки в контейнер

**Если используете `docker run`:**

```bash
docker run \
  -e DOCUMENT_TEMPLATES_DIR=/data/document-templates \
  -v /home/deploy/crm-templates:/data/document-templates \
  ... остальные флаги и образ бэкенда
```

Здесь:
- `/home/deploy/crm-templates` — папка на хосте с файлами `act-....xlsx` и `invoice-....xlsx`;
- `/data/document-templates` — путь внутри контейнера; он же задан в `DOCUMENT_TEMPLATES_DIR`.

**Если используете docker-compose** (файл может быть у вас вне репозитория):

```yaml
services:
  backend:
    image: your-backend-image
    environment:
      DOCUMENT_TEMPLATES_DIR: /data/document-templates
    volumes:
      - /home/deploy/crm-templates:/data/document-templates
    # ... порты, зависимости и т.д.
```

Или с именованным volume:

```yaml
volumes:
  crm-templates:

services:
  backend:
    image: your-backend-image
    environment:
      DOCUMENT_TEMPLATES_DIR: /data/document-templates
    volumes:
      - crm-templates:/data/document-templates
```

После первого запуска с volume нужно один раз положить файлы в этот volume, например:

```bash
docker cp act-1769783861347.xlsx <имя_или_id_контейнера>:/data/document-templates/
docker cp invoice-1769783876176.xlsx <имя_или_id_контейнера>:/data/document-templates/
```

### 3.5. Проверка

- Перезапустите контейнер бэкенда.
- Сгенерируйте акт и счёт из CRM. Не должно быть 404 по шаблону.
- После следующего деплоя/пересборки контейнера шаблоны снова должны находиться (файлы остаются в volume/папке на хосте).

---

## 4. Вариант B: Бэкенд на хосте (systemd, pm2, node напрямую)

Тогда «постоянная папка» — просто каталог на сервере, который не очищается при деплое (например, не внутри `dist/` и не в каталоге сборки).

### 4.1. Создать каталог и положить файлы

Пример:

```bash
sudo mkdir -p /opt/crm/document-templates
sudo chown <пользователь, под которым крутится бэкенд> /opt/crm/document-templates
```

Скопируйте туда `act-1769783861347.xlsx` и `invoice-1769783876176.xlsx`.

### 4.2. Задать переменную окружения

В unit systemd (в `Environment=` или `EnvironmentFile=`) или в конфиге pm2 / скрипте запуска:

```bash
export DOCUMENT_TEMPLATES_DIR=/opt/crm/document-templates
```

Перезапустите процесс бэкенда и проверьте генерацию акта/счёта.

---

## 5. Если имён файлов в БД нет под рукой

Посмотреть их можно в БД:

```sql
SELECT id, name, type, file_path FROM document_templates WHERE type IN ('act', 'invoice');
```

В `file_path` будет что-то вроде `/usr/src/app/dist/templates/act-1769783861347.xlsx`. Имя файла — последняя часть пути: `act-1769783861347.xlsx`, `invoice-1769783876176.xlsx`. Именно такие имена должны лежать в `DOCUMENT_TEMPLATES_DIR`.

---

## 6. Загрузка новых шаблонов через UI

После настройки `DOCUMENT_TEMPLATES_DIR` новые шаблоны, загруженные через интерфейс CRM, будут сохраняться сразу в эту папку (или volume), и после деплоя продолжат находиться. Перезаливать старые шаблоны не обязательно — достаточно положить файлы с правильными именами в настроенную папку один раз.
