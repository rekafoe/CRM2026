# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ CRM

## üéØ –û–±–∑–æ—Ä

–í —Å–∏—Å—Ç–µ–º–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç **4 —Å–µ—Ä–≤–∏—Å–∞**, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∞—Å—á–µ—Ç–æ–º —Ü–µ–Ω. –í–æ—Ç –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞:

---

## ‚úÖ 1. UnifiedPricingService (–ì–õ–ê–í–ù–´–ô - –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)

**–§–∞–π–ª**: `backend/src/modules/pricing/services/unifiedPricingService.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: üéØ **–ï–î–ò–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´ –¥–ª—è —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è**

### API Endpoints:
```
POST /api/pricing/calculate
POST /api/products/:productId/calculate
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å `productId` –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
2. –í—ã–∑—ã–≤–∞–µ—Ç `FlexiblePricingService.calculatePrice()`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
```typescript
POST /api/products/58/calculate

{
  product_id: 58,
  quantity: 100,
  params: {
    material_id: 44,
    format: '210√ó297',
    print_method: '–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Ü–≤–µ—Ç–Ω–∞—è'
  }
}
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
```json
{
  "productId": 58,
  "productName": "–®—Ç—É–∫–∏",
  "quantity": 100,
  "finalPrice": 12.00,
  "pricePerUnit": 0.12,
  "materialCost": 7.50,
  "operationsCost": 2.50,
  "subtotal": 10.00,
  "markup": 2.00,
  "materials": [...],
  "operations": [...],
  "calculationMethod": "flexible_operations"
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ Quick Test –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —à–∞–±–ª–æ–Ω–∞
- ‚úÖ –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã —Ü–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–æ–≤

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ê–ö–¢–ò–í–ù–´–ô - –ì–õ–ê–í–ù–´–ô –°–ï–†–í–ò–°**

---

## ‚öôÔ∏è 2. FlexiblePricingService (–í–ù–£–¢–†–ï–ù–ù–ò–ô - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UnifiedPricingService)

**–§–∞–π–ª**: `backend/src/modules/pricing/services/flexiblePricingService.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –æ–ø–µ—Ä–∞—Ü–∏–π (–Ω–æ–≤–∞—è –≥–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞)

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. **–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç** –∏–∑ –ë–î (`products`)
2. **–ü–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã** –∏–∑ `product_template_configs`
3. **–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å–∫–ª–∞–¥–∫—É** —á–µ—Ä–µ–∑ `LayoutCalculationService`
   - `sheetsNeeded` - —Å–∫–æ–ª—å–∫–æ –ª–∏—Å—Ç–æ–≤ –Ω—É–∂–Ω–æ
   - `itemsPerSheet` - —Å–∫–æ–ª—å–∫–æ –∏–∑–¥–µ–ª–∏–π –Ω–∞ –ª–∏—Å—Ç–µ
4. **–ü–æ–ª—É—á–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã**:
   ```sql
   SELECT m.* FROM materials m
   WHERE m.id = :material_id
   ```
5. **–ü–æ–ª—É—á–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏**:
   ```sql
   SELECT * FROM product_operations_link pol
   JOIN post_processing_services pps ON pol.operation_id = pps.id
   WHERE pol.product_id = :productId
   ```
6. **–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏**:
   - –ü–µ—á–∞—Ç—å: `sheetsNeeded √ó price_per_sheet`
   - –†–µ–∑–∫–∞: `cutsNeeded √ó price_per_cut`
   - –õ–∞–º–∏–Ω–∞—Ü–∏—è: `itemsNeeded √ó price_per_item`
7. **–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è** (`operation_pricing_rules`):
   - `quantity_discount` - —Å–∫–∏–¥–∫–∏ –Ω–∞ —Ç–∏—Ä–∞–∂
   - `rush` - –Ω–∞—Ü–µ–Ω–∫–∞ –∑–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç—å
   - `material_based` - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞
8. **–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Ç–æ–≥**:
   ```
   materialCost + operationsCost + setupCosts
   ‚Üí subtotal
   ‚Üí subtotal √ó markup%
   ‚Üí finalPrice
   ```

### –¢–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- `products`
- `product_template_configs`
- `materials`
- `product_operations_link`
- `post_processing_services`
- `operation_pricing_rules`

### –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑:
```typescript
// –¢–æ–ª—å–∫–æ –∏–∑ UnifiedPricingService!
const result = await FlexiblePricingService.calculatePrice(
  productId,
  configuration,
  quantity
);
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ê–ö–¢–ò–í–ù–´–ô - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UnifiedPricingService**

**–í–∞–∂–Ω–æ**: –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ API, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ UnifiedPricingService!

---

## üìä 3. CostCalculationService (–ê–ù–ê–õ–ò–¢–ò–ö–ê - –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)

**–§–∞–π–ª**: `backend/src/modules/pricing/services/costCalculationService.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ê–Ω–∞–ª–∏–∑ **—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏** –∏ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤)

### API Endpoints:
```
POST /api/cost-calculation/calculate      - –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
GET  /api/cost-calculation/history        - –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤
POST /api/cost-calculation/compare        - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
POST /api/cost-calculation/profitability  - –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏
GET  /api/cost-calculation/report         - –û—Ç—á–µ—Ç –ø–æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–∑–∞—Ç—Ä–∞—Ç—ã):
   - –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫—É–ø–∫–∏
   - –£—Å–ª—É–≥–∏: —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
2. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Ü–µ–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   - `totalCost` - —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
   - `sellingPrice` - —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
   - `profit` - –ø—Ä–∏–±—ã–ª—å
   - `profitMargin` - % –º–∞—Ä–∂–∏
   - `margin` - –Ω–∞—Ü–µ–Ω–∫–∞

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```typescript
POST /api/cost-calculation/calculate

{
  "productType": "business_cards",
  "productVariant": "premium",
  "quantity": 100
}

// –û—Ç–≤–µ—Ç:
{
  "breakdown": {
    "totalMaterialCost": 7.50,     // –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
    "totalServiceCost": 2.50,      // –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —É—Å–ª—É–≥–∏
    "totalCost": 10.00,            // –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨
    "sellingPrice": 12.00,         // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
    "profit": 2.00,                // –ü—Ä–∏–±—ã–ª—å
    "profitMargin": 16.67          // % –º–∞—Ä–∂–∏
  },
  "recommendations": [
    "–ú–∞—Ä–∂–∞ –Ω–∏–∂–µ —Ü–µ–ª–µ–≤–æ–π (30%). –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —Ü–µ–Ω—ã.",
    "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç 75% —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏."
  ],
  "warnings": [
    "–ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞! –¶–µ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–π."
  ]
}
```

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
- üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
- üìä –û—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏
- üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- üìä –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏

**–°—Ç–∞—Ç—É—Å**: üìä **–ê–ö–¢–ò–í–ù–´–ô - –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –ù–ï –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω –∫–ª–∏–µ–Ω—Ç–∞–º**

**–í–∞–∂–Ω–æ**: –≠—Ç–æ –ù–ï —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, –∞ –∞–Ω–∞–ª–∏–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏!

---

## ‚ö†Ô∏è 4. UniversalCalculatorService (LEGACY - —Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)

**–§–∞–π–ª**: `backend/src/modules/products/services/universalCalculatorService.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π `product_material_rules` (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)

### API Endpoints:
```
POST /api/universal-calculator/calculate   - –†–∞—Å—á–µ—Ç –ø–æ —Å—Ç–∞—Ä—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
GET  /api/universal-calculator/rules       - –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
POST /api/universal-calculator/rules       - –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ
DELETE /api/universal-calculator/rules/:id - –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
POST /api/universal-calculator/clone-rules - –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–∞–±–ª–∏—Ü–µ–π `product_material_rules`
2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ —Ç–∏–ø—É –ø—Ä–æ–¥—É–∫—Ç–∞ (productType + productName)
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞:
   - `qty_per_item` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É
   - `calculation_type`: per_item, per_sheet, per_sqm, fixed

### –¢–∞–±–ª–∏—Ü–∞ product_material_rules:
```sql
CREATE TABLE product_material_rules (
  id INTEGER PRIMARY KEY,
  product_type TEXT NOT NULL,        -- 'flyers', 'business_cards'
  product_name TEXT,                 -- 'A4', 'premium'
  material_id INTEGER NOT NULL,
  qty_per_item REAL NOT NULL,
  calculation_type TEXT,             -- 'per_item', 'per_sheet', 'per_sqm'
  is_required INTEGER DEFAULT 1
)
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```typescript
POST /api/universal-calculator/calculate

{
  "productType": "flyers",
  "productName": "A4",
  "quantity": 100
}

// –ò—â–µ—Ç –≤ product_material_rules:
// WHERE product_type = 'flyers' AND product_name = 'A4'
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ —Å—Ç–∞—Ä—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
```

**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è **LEGACY - —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å–∏—Å—Ç–µ–º–∞**

### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –î—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (productType + productName –≤–º–µ—Å—Ç–æ productId)
- ‚ùå –¢–∞–±–ª–∏—Ü–∞ `product_material_rules` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –≥–¥–µ-—Ç–æ, –∏ –µ—Å–ª–∏ –Ω–µ—Ç - **DEPRECATED**

---

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | UnifiedPricing | FlexiblePricing | CostCalculation | UniversalCalculator |
|---------------|----------------|-----------------|-----------------|---------------------|
| **–¶–µ–ª—å** | –¶–µ–Ω–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ | –†–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ü–∏–∏ | –ê–Ω–∞–ª–∏–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ | –°—Ç–∞—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞ |
| **API** | `/pricing/calculate` | –ù–µ—Ç (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π) | `/cost-calculation/calculate` | `/universal-calculator/calculate` |
| **–¢–∞–±–ª–∏—Ü—ã** | –ß–µ—Ä–µ–∑ Flexible | operations, materials | materials, services | product_material_rules |
| **–î–ª—è –∫–æ–≥–æ** | –ö–ª–∏–µ–Ω—Ç—ã | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π | –ú–µ–Ω–µ–¥–∂–µ—Ä—ã/–ê–¥–º–∏–Ω—ã | Legacy |
| **–°—Ç–∞—Ç—É—Å** | ‚úÖ –ì–õ–ê–í–ù–´–ô | ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø | üìä –ê–ù–ê–õ–ò–¢–ò–ö–ê | ‚ö†Ô∏è LEGACY |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** | –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä | UnifiedPricing | –û—Ç—á–µ—Ç—ã | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è? |

---

## üîÑ –ü–æ–ª–Ω—ã–π flow —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞

```
1Ô∏è‚É£ –ö–ª–∏–µ–Ω—Ç –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
   ‚Üì
   –í—ã–±–∏—Ä–∞–µ—Ç: –º–∞—Ç–µ—Ä–∏–∞–ª, —Ñ–æ—Ä–º–∞—Ç, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
   ‚Üì
   –ù–∞–∂–∏–º–∞–µ—Ç "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"

2Ô∏è‚É£ Frontend
   ‚Üì
   POST /api/products/58/calculate
   {
     product_id: 58,
     quantity: 100,
     params: { material_id: 44, ... }
   }

3Ô∏è‚É£ UnifiedPricingService.calculatePrice()
   ‚Üì
   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —É –ø—Ä–æ–¥—É–∫—Ç–∞
   ‚Ä¢ –í—ã–∑—ã–≤–∞–µ—Ç FlexiblePricingService

4Ô∏è‚É£ FlexiblePricingService.calculatePrice()
   ‚Üì
   a) –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç (products)
   b) –ü–æ–ª—É—á–∞–µ—Ç —à–∞–±–ª–æ–Ω (product_template_configs)
   c) –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å–∫–ª–∞–¥–∫—É (LayoutCalculationService)
   d) –ü–æ–ª—É—á–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª:
      SELECT * FROM materials WHERE id = 44
      ‚Üí matt 300, price: 0.75 BYN
   e) –ü–æ–ª—É—á–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏:
      SELECT * FROM product_operations_link pol
      JOIN post_processing_services pps
      WHERE pol.product_id = 58
      ‚Üí –ü–µ—á–∞—Ç—å (0.15 BYN/–ª–∏—Å—Ç), –†–µ–∑–∫–∞ (0.05 BYN/—Ä–µ–∑)
   f) –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å:
      ‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: 10 –ª–∏—Å—Ç–æ–≤ √ó 0.75 = 7.50 BYN
      ‚Ä¢ –ü–µ—á–∞—Ç—å: 10 –ª–∏—Å—Ç–æ–≤ √ó 0.15 = 1.50 BYN
      ‚Ä¢ –†–µ–∑–∫–∞: 20 —Ä–µ–∑–æ–≤ √ó 0.05 = 1.00 BYN
      ‚Ä¢ Subtotal: 10.00 BYN
      ‚Ä¢ Markup 20%: +2.00 BYN
      ‚Ä¢ –ò–¢–û–ì–û: 12.00 BYN
   g) –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ (operation_pricing_rules)

5Ô∏è‚É£ –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
   ‚Üì
   {
     finalPrice: 12.00,
     pricePerUnit: 0.12,
     materials: [...],
     operations: [...]
   }

6Ô∏è‚É£ –ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∑–∞–∫–∞–∑
   ‚Üì
   POST /api/orders/:orderId/items
   {
     price: 0.12,          // ‚Üê –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
     quantity: 100,
     params: { ... },      // –ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
     components: [         // –î–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
       { materialId: 44, qtyPerItem: 0.1 }
     ]
   }

7Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
   ‚Üì
   INSERT INTO items (orderId, type, params, price, quantity)
   VALUES (123, '–®—Ç—É–∫–∏', '...JSON...', 0.12, 100)
   
   INSERT INTO material_reservations (material_id, quantity_reserved)
   VALUES (44, 10)
```

**–í—ã–≤–æ–¥**: ‚úÖ –¢–æ–ª—å–∫–æ **–û–î–ò–ù** —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç—É!

---

## üìä –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (–Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞—Å—á–µ—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)

### CostCalculationService - –ê–Ω–∞–ª–∏–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏

**–¶–µ–ª—å**: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç**:
```
–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: 10.00 BYN      (–Ω–∞—à–∏ –∑–∞—Ç—Ä–∞—Ç—ã)
–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: 12.00 BYN       (–æ—Ç UnifiedPricingService)
–ü—Ä–∏–±—ã–ª—å: 2.00 BYN
–ú–∞—Ä–∂–∞: 20%

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –ú–∞—Ä–∂–∞ –Ω–∏–∂–µ —Ü–µ–ª–µ–≤–æ–π (30%)
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç 75% —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –û—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ

---

### UniversalCalculatorService - –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞

**–¶–µ–ª—å**: ‚ö†Ô∏è –£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å `product_material_rules`

**–¢–∞–±–ª–∏—Ü–∞**: `product_material_rules` (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ)

**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è **LEGACY** - –≤–µ—Ä–æ—è—Ç–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ DEPRECATED

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –û–¢–í–ï–¢

### –î–∞, —Ü–µ–Ω—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –µ—â–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö, –ù–û:

1. **–î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã)**: ‚úÖ **–¢–û–õ–¨–ö–û UnifiedPricingService**
   - –í—ã–∑—ã–≤–∞–µ—Ç FlexiblePricingService –≤–Ω—É—Ç—Ä–∏
   - –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º

2. **–î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)**: üìä **CostCalculationService**
   - –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏
   - –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–µ–Ω—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

3. **Legacy (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)**: ‚ö†Ô∏è **UniversalCalculatorService**
   - –¢–∞–±–ª–∏—Ü–∞ product_material_rules
   - –í–µ—Ä–æ—è—Ç–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - –ú–æ–∂–Ω–æ deprecated

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ß—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. ‚úÖ **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞** - UnifiedPricingService
2. ‚úÖ **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** - —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã vs –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
3. ‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - FlexiblePricingService –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É

### ‚ö†Ô∏è –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:
1. ‚ö†Ô∏è **–ü–æ–º–µ—Ç–∏—Ç—å UniversalCalculatorService –∫–∞–∫ DEPRECATED**
   - –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —É–¥–∞–ª–∏—Ç—å
   - –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É

2. ‚ö†Ô∏è **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏–µ**:
   - UnifiedPricing = —Ü–µ–Ω–∞ –¥–ª—è –ö–õ–ò–ï–ù–¢–ê
   - CostCalculation = –∞–Ω–∞–ª–∏–∑ –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–ò

3. ‚ö†Ô∏è **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å product_material_rules**:
   - –ù—É–∂–Ω–∞ –ª–∏ —ç—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞?
   - –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç –ª–∏ –æ–Ω–∞ product_operations_link?

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è UniversalCalculatorService

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞:

```bash
# –ü–æ–∏—Å–∫ –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ –∫–æ–¥–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
grep -r "universal-calculator/calculate" frontend/src
grep -r "UniversalCalculatorService" backend/src
```

**–ï—Å–ª–∏ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** ‚Üí –º–æ–∂–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ DEPRECATED:

```typescript
/**
 * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ UnifiedPricingService –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ
 * –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü–µ–π product_material_rules
 * –∏ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.
 */
export class UniversalCalculatorService {
  // ...
}
```

---

## ‚ú® –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å**: –î–∞, —Ü–µ–Ω—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:

1. ‚úÖ **UnifiedPricingService + FlexiblePricingService** ‚Üí –¶–µ–Ω–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ì–õ–ê–í–ù–´–ô)
2. üìä **CostCalculationService** ‚Üí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π)
3. ‚ö†Ô∏è **UniversalCalculatorService** ‚Üí –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (legacy, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

**–ì–ª–∞–≤–Ω–æ–µ**: –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–¢–û–õ–¨–ö–û UnifiedPricingService**! ‚úÖ

–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –ø—Ä–æ–≤–µ—Ä–∏–ª, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ `UniversalCalculatorService` –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ, –∏ –µ—Å–ª–∏ –Ω–µ—Ç - –ø–æ–º–µ—Ç–∏–ª –µ–≥–æ –∫–∞–∫ DEPRECATED? üîç

