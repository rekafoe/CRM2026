# üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∏–Ω–æ–º

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª–æ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/login`.

## –ü—Ä–∏—á–∏–Ω–∞

1. **Race condition** –º–µ–∂–¥—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –¥–µ–ª–∞–ª—Å—è `navigate('/')` ‚Üí React Router –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª `App` ‚Üí `useAppData` –¥–µ–ª–∞–ª –∑–∞–ø—Ä–æ—Å—ã
3. Axios interceptor –≤ `utils/api.ts` –ª–æ–≤–∏–ª 401 –æ—à–∏–±–∫—É –∏ —Å—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–ª –Ω–∞ `/login`
4. –¢–æ–∫–µ–Ω –Ω–µ —É—Å–ø–µ–≤–∞–ª "–ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è" –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `window.location.href` –≤–º–µ—Å—Ç–æ `navigate`

**–î–æ:**
```typescript
setAuthToken(res.data.token);
localStorage.setItem(...);
navigate('/', { replace: true }); // ‚ùå –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
```

**–ü–æ—Å–ª–µ:**
```typescript
localStorage.setItem('crmToken', token);
localStorage.setItem(...);
window.location.href = '/'; // ‚úÖ –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- `window.location.href = '/'` –≤—ã–∑—ã–≤–∞–µ—Ç **–ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É** —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ü—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ axios interceptor –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ª—É—á–∏—Ç —Ç–æ–∫–µ–Ω –∏–∑ localStorage
- –ù–µ—Ç race condition –º–µ–∂–¥—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. –£–ª—É—á—à–µ–Ω–∏–µ axios interceptor'–∞ –¥–ª—è 401 –æ—à–∏–±–æ–∫

**–î–æ:**
```typescript
if (error.response?.status === 401) {
  localStorage.removeItem('crmToken');
  window.location.href = '/login'; // ‚ùå –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞
}
```

**–ü–æ—Å–ª–µ:**
```typescript
if (error.response?.status === 401) {
  const currentPath = window.location.pathname;
  if (currentPath !== '/login') { // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –º—ã
    localStorage.removeItem('crmToken');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userId');
    localStorage.removeItem('sessionDate');
    
    setTimeout(() => {
      window.location.href = '/login';
    }, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è race condition
  }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- –ù–µ –ø—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ `/login`, –µ—Å–ª–∏ —É–∂–µ –Ω–∞ –Ω–µ–º
- –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
- –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 100ms –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```typescript
console.log('‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', token.substring(0, 20) + '...');
```

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, –∫–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–∫–µ–Ω.

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

- `frontend/src/pages/LoginPage.tsx` - –≥–ª–∞–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- `frontend/src/utils/api.ts` - —É–ª—É—á—à–µ–Ω–∏–µ interceptor'–∞

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞–∂–Ω–æ! –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞

‚ùå **–ù–ï –û–¢–ö–†–´–í–ê–ô–¢–ï** `dist/index.html` –Ω–∞–ø—Ä—è–º—É—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ!  
‚úÖ **–ò–°–ü–û–õ–¨–ó–£–ô–¢–ï** Vite dev server –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```bash
cd frontend
npm run dev
```

–ó–∞—Ç–µ–º –æ—Ç–∫—Ä—ã—Ç—å `http://localhost:5173`

### –ü–æ—á–µ–º—É?

- Proxy –≤ `vite.config.ts` —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ** —á–µ—Ä–µ–∑ dev —Å–µ—Ä–≤–µ—Ä
- –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞ –Ω–∞–ø—Ä—è–º—É—é: `/api/auth/login` ‚Üí `file:///api/auth/login` ‚ùå
- –ß–µ—Ä–µ–∑ dev —Å–µ—Ä–≤–µ—Ä: `/api/auth/login` ‚Üí `http://localhost:3001/api/auth/login` ‚úÖ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ backend

```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å backend
cd backend
npm start

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ backend –¥–æ—Å—Ç—É–ø–µ–Ω
curl http://localhost:3001/health
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: {"status":"OK"}
```

### –®–∞–≥–∏ —Ç–µ—Å—Ç–∞

1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É **3001**
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å frontend dev —Å–µ—Ä–≤–µ—Ä: `npm run dev`
3. –û—Ç–∫—Ä—ã—Ç—å `http://localhost:5173/login`
4. –í–≤–µ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - Email: `admin@example.com`
   - –ü–∞—Ä–æ–ª—å: `admin`
5. –ù–∞–∂–∞—Ç—å "–í–æ–π—Ç–∏"
6. **–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/` ‚Üí –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
7. **–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:** 
   - –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ `/login`
   - –û—à–∏–±–∫–∏ "401 Unauthorized"

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ navigate
```typescript
await new Promise(resolve => setTimeout(resolve, 100));
navigate('/', { replace: true });
```
‚ùå **–ú–∏–Ω—É—Å:** –ù–µ–Ω–∞–¥–µ–∂–Ω–æ, –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### –í–∞—Ä–∏–∞–Ω—Ç 2: –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ React
```typescript
const [token, setToken] = useState(null);
```
‚ùå **–ú–∏–Ω—É—Å:** –°–ª–æ–∂–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏, —Ç–æ–∫–µ–Ω —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ

### –í–∞—Ä–∏–∞–Ω—Ç 3: Context API –¥–ª—è —Ç–æ–∫–µ–Ω–∞
```typescript
<AuthContext.Provider value={{ token }}>
```
‚ùå **–ú–∏–Ω—É—Å:** –ò–∑–ª–∏—à–Ω–µ —Å–ª–æ–∂–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## –í—ã–≤–æ–¥

‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º `window.location.href` –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞  
‚úÖ –£–ª—É—á—à–µ–Ω interceptor –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏  

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!** üéâ

