# Анализ себестоимости продукта 58 "Штуки"

## 📊 Итоговый отчет после исправлений

**Дата**: 4 декабря 2025  
**Продукт**: ID 58 "Штуки"  
**Формат**: 210×297 мм (A4)  
**Тираж**: 100 шт

---

## ✅ Исправленные проблемы

### 1. **Операция резки настроена неправильно** ✅ ИСПРАВЛЕНО

**До**:
```
price_unit: 'per_sheet'
Расчет: 50 листов × 1 BYN = 50 BYN  ❌
```

**После**:
```
price_unit: 'per_cut'
Расчет: 5 резов × 1 стопа = 5 резов × 1 BYN = 5 BYN  ✅
```

**Экономия**: 45 BYN!

---

### 2. **Добавлен 'per_cut' в схему БД** ✅ ИСПРАВЛЕНО

**Файл**: `backend/schema/current_schema.sql`

**Было**:
```sql
price_unit TEXT CHECK(price_unit IN (
  'per_sheet', 'per_item', 'per_m2', 'per_hour', 'fixed', 'per_order'
))
```

**Стало**:
```sql
price_unit TEXT CHECK(price_unit IN (
  'per_sheet', 'per_item', 'per_m2', 'per_hour', 'fixed', 'per_order', 'per_cut'
))
```

---

## 💰 Себестоимость продукта 58

### Для тиража 100 шт, формат A4 (210×297 мм):

#### 📐 Раскладка (LayoutCalculationService):
```
Лист: SRA3 (320×450 мм)
С поворотом на 90°:
  • Колонки: 1
  • Ряды: 2
  • Изделий на лист: 2 шт
  • Нужно листов: 50
  • Резов на лист: 5
  • Стоп: 1 (50 листов ÷ 333 листов/стопа)
  • Всего резов: 5
```

#### 📦 Материалы:
```
matt 250 (Полуматовая 250 г/м²)
50 листов × 0.75 BYN = 37.50 BYN
```

#### 🔧 Операции:
```
1. Резка на гильотине (per_cut):
   5 резов × 1 BYN = 5.00 BYN
   Setup: 5 BYN

2. Цифровая цветная печать (per_sheet):
   50 листов × 0.25 BYN = 12.50 BYN
   Setup: 0 BYN

3. Цифровая ч/б печать (per_sheet):
   50 листов × 0.11 BYN = 5.50 BYN
   Setup: 0 BYN
```

**⚠️ Проблема**: Две операции печати применяются одновременно!

---

## 📊 Финальный расчет

### Вариант A: С обеими печатями (текущая настройка - неправильно)

```
📦 Материалы:           37.50 BYN
🔧 Операции:           23.00 BYN
   • Резка:      5.00 BYN  ✅ (было 50 BYN)
   • Цветная:   12.50 BYN
   • Ч/Б:        5.50 BYN  ⚠️ Лишняя!
⚙️  Setup:                5.00 BYN
─────────────────────────────────────
💵 СЕБЕСТОИМОСТЬ:       65.50 BYN

💸 Наценка (×2.2):     +78.60 BYN (120%)
─────────────────────────────────────
ЦЕНА С НАЦЕНКОЙ:       144.10 BYN

💸 Скидка 8%:          -11.53 BYN
─────────────────────────────────────
🎯 ИТОГОВАЯ ЦЕНА:       132.57 BYN

💡 За штуку:             1.33 BYN
```

---

### Вариант B: Только цветная печать (правильная настройка)

```
📦 Материалы:           37.50 BYN
🔧 Операции:           17.50 BYN
   • Резка:      5.00 BYN  ✅
   • Цветная:   12.50 BYN  ✅
⚙️  Setup:                5.00 BYN
─────────────────────────────────────
💵 СЕБЕСТОИМОСТЬ:       60.00 BYN  ← ПРАВИЛЬНАЯ!

💸 Наценка (×2.2):     +72.00 BYN (120%)
─────────────────────────────────────
ЦЕНА С НАЦЕНКОЙ:       132.00 BYN

💸 Скидка 8%:          -10.56 BYN
─────────────────────────────────────
🎯 ИТОГОВАЯ ЦЕНА:       121.44 BYN

💡 За штуку:             1.21 BYN
```

---

### Вариант C: Только Ч/Б печать (если нужно)

```
📦 Материалы:           37.50 BYN
🔧 Операции:           10.50 BYN
   • Резка:      5.00 BYN  ✅
   • Ч/Б:        5.50 BYN  ✅
⚙️  Setup:                5.00 BYN
─────────────────────────────────────
💵 СЕБЕСТОИМОСТЬ:       53.00 BYN  ← САМАЯ НИЗКАЯ!

💸 Наценка (×2.2):     +63.60 BYN (120%)
─────────────────────────────────────
ЦЕНА С НАЦЕНКОЙ:       116.60 BYN

💸 Скидка 8%:           -9.33 BYN
─────────────────────────────────────
🎯 ИТОГОВАЯ ЦЕНА:       107.27 BYN

💡 За штуку:             1.07 BYN
```

---

## 🎯 Ответы на ваши вопросы:

### 1. **Наценка в системе**:
✅ **120%** (коэффициент 2.2x)

```
Настройка БД:
markup_settings.base_markup = 2.2

Формула:
Цена = Себестоимость × 2.2
Наценка = Себестоимость × 1.2 = 120%
```

### 2. **Себестоимость продукта 58** (100 шт, A4):

При **правильной настройке** (одна операция печати):
- **С цветной печатью**: 60.00 BYN
- **С Ч/Б печатью**: 53.00 BYN

При **текущей настройке** (обе печати):
- 65.50 BYN (завышено на 5.50 BYN)

---

## 📋 Структура себестоимости

### Для варианта "Цветная печать":

```
Материалы:      37.50 BYN  (62.5%)
Операции:       17.50 BYN  (29.2%)
  ├─ Резка:      5.00 BYN  (правильно с учетом стоп!)
  └─ Печать:    12.50 BYN
Setup:           5.00 BYN  (8.3%)
─────────────────────────────────────
ИТОГО:          60.00 BYN  (100%)
```

---

## ✨ Что было исправлено:

1. ✅ **Схема БД**: Добавлен `'per_cut'` в допустимые значения `price_unit`
2. ✅ **Операция резки**: Изменена с `per_sheet` на `per_cut`
3. ✅ **Расчет резки**: Теперь учитывает стопы (5 резов вместо 250!)
4. ✅ **Экономия**: 45 BYN на каждые 100 шт!

---

## 🔄 Как работает расчет резки:

### До исправления ❌:
```
price_unit: 'per_sheet'
Логика: Режем каждый лист отдельно
Расчет: 50 листов × 1 BYN = 50 BYN
```

### После исправления ✅:
```
price_unit: 'per_cut'
Логика: Режем стопу листов одновременно

Параметры:
  • Высота стопы: 50 мм (5 см)
  • Толщина листа: 0.15 мм
  • Листов в стопе: 333
  • Для 50 листов: 1 стопа
  • Резов на лист: 5
  • Всего резов: 5 × 1 = 5

Расчет: 5 резов × 1 BYN = 5 BYN  ✅
```

---

## 🎯 Рекомендации:

### 1. **Сделать операции печати условными** (КРИТИЧНО)

Сейчас применяются обе печати одновременно. Нужно:

a) Добавить параметр выбора:
```typescript
{
  name: 'print_color_mode',
  type: 'select',
  options: ['Цветная', 'Ч/Б']
}
```

b) Добавить условия к операциям:
```typescript
// Цветная печать
{
  operation_id: 2,
  conditions: { print_method: 'Двусторонняя цветная' }
}

// Ч/Б печать
{
  operation_id: 3,
  conditions: { print_method: 'Односторонняя цветная' } // или другое условие
}
```

### 2. **Очистить дублирующиеся скидки**

В БД есть конфликтующие правила:
```sql
100-199: 12%
100-499:  5%  ← Конфликт!

500+:    20%
500-999: 10%  ← Конфликт!
```

Нужно оставить только один набор правил.

---

## 📈 Сравнение: До и После

| Показатель | До исправления | После исправления | Экономия |
|------------|----------------|-------------------|----------|
| Резка | 50.00 BYN | 5.00 BYN | 45.00 BYN |
| Операции (всего) | 68.00 BYN | 23.00 BYN | 45.00 BYN |
| Себестоимость | 110.50 BYN | 65.50 BYN | 45.00 BYN |
| Цена клиенту | 223.65 BYN | 132.57 BYN | 91.08 BYN |
| Цена за шт | 2.24 BYN | 1.33 BYN | 0.91 BYN |

**Снижение цены**: **40%**! 🎉

---

## ✅ Заключение:

### Вы были абсолютно правы! 🎯

1. ✅ **Раскладка работает правильно**: 2 изделия на лист
2. ✅ **Система учитывает стопы**: 333 листа в стопе
3. ✅ **Резка должна быть per_cut**: 5 резов, а не 250!
4. ✅ **Наценка 120%** (2.2x), а не 20%

### Текущая себестоимость продукта 58:
- **60.00 BYN** (с одной операцией печати - правильно)
- **65.50 BYN** (с двумя операциями - текущая настройка)

### Итоговая цена для клиента:
- **121.44 BYN** (с одной печатью) = **1.21 BYN за шт**
- **132.57 BYN** (с двумя печатями) = **1.33 BYN за шт**

**Статус**: ✅ Операция резки исправлена! Осталось настроить условные печати.

