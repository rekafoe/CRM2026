# Области для улучшения CRM

Краткий обзор направлений, по которым можно развивать систему: производительность, архитектура, качество кода и UX.

---

## 1. Производительность

### Backend
- **Кеш схемы таблиц** — 50+ вызовов `PRAGMA table_info` при запросах; вынести в `tableSchemaCache` с TTL и инвалидацией после миграций.
- **N+1 при загрузке заказов** — items подгружаются в цикле по заказам; заменить на один запрос `WHERE orderId IN (...)` и группировку в памяти.
- **Кеш справочников** — операции, статусы, категории материалов, настройки принтеров редко меняются; кешировать в памяти с TTL (например, 5–10 мин) и инвалидировать при изменении.
- **JOIN вместо отдельных запросов** — в `orderService.searchOrders`, `earningsService` объединять загрузку заказов и items через JOIN или батч-запросы.
- **Индексы БД** — проверить частые фильтры (orderId, date, status, productId) и при необходимости добавить индексы.

### Frontend
- **Lazy loading страниц** — тяжёлые страницы (PricingManagement, AdminReportsPage, CalculatorProductManager, DocumentTemplates, WarehouseReports) подгружать через `React.lazy()` и `Suspense`, чтобы уменьшить начальный бандл.
- **Мемоизация** — тяжёлые вычисления (калькулятор, отчёты, списки с фильтрами) обернуть в `useMemo` / `useCallback` или вынести в селекторы.
- **Виртуализация длинных списков** — списки заказов, материалов, продуктов при большом количестве строк рендерить через виртуальный скролл (react-window / react-virtuoso).

---

## 2. Архитектура и структура кода

- **Точка входа** — сейчас используется `index_old.ts`; переименовать в `index.ts` и удалить дубликат, чтобы не путать новых разработчиков.
- **Дублирование сервисов** — два файла `optimizedQueries.ts` (в `services/` и `modules/shared/services/`); оставить один источник правды и обновить импорты.
- **Размер компонентов** — крупные файлы (PricingManagement 1300+ строк, CustomersAdminPage 1390, ImprovedPrintingCalculatorModal 1300+) разбить на подкомпоненты и хуки по зонам ответственности (формы принтеров/услуг/наценок, таблицы, модалки).
- **Роутинг API** — часть логики в роутах (например, products), часть в контроллерах; по возможности унифицировать: роут → контроллер → сервис.

---

## 3. Качество кода и поддержка

- **Неиспользуемые файлы** — удалить примеры (`examples/`, `StateManagementTestPanel`), временные файлы (`Untitled-1.ini`), устаревший legacy (например, `calculators.ts`), если фронт к нему не обращается.
- **Типизация** — постепенно убирать `any`, ввести общие типы для заказов, продуктов, шаблонов в `shared/types` и использовать и на бэкенде, и на фронте.
- **Тесты** — расширить покрытие: критические сервисы (расчёт цен, формирование документов, сохранение заказов), ключевые API (auth, orders, document-templates).
- **Логирование и мониторинг** — единый формат логов (уровень, requestId, время), алерты на 5xx и критические ошибки (например, в Telegram или другой канал).

---

## 4. Безопасность и надёжность

- **Валидация входных данных** — проверка типов и форматов (query/body) на роутах (например, через Zod/Joi) перед вызовом сервисов.
- **Лимиты и пагинация** — все списки (заказы, продукты, материалы) с пагинацией и ограничением `limit`; не отдавать тысячи записей одним ответом.
- **Резервное копирование БД** — автоматические бэкапы SQLite на проде (Railway volume или внешнее хранилище) и проверка восстановления.

---

## 5. UX и функциональность

- **Обратная связь при действиях** — тосты/уведомления при сохранении, удалении, загрузке шаблонов; состояние загрузки для долгих операций (отчёты, экспорт).
- **Ошибки сети** — повтор запроса при 5xx/таймаутах, понятные сообщения при отсутствии сети или недоступности API.
- **Поиск и фильтры** — единообразное поведение поиска по заказам, клиентам, продуктам; сохранение фильтров в URL (query) для шаринга и обновления страницы.
- **Мобильная версия** — проверить ключевые сценарии (заказы, калькулятор, клиенты) на маленьких экранах и при необходимости доработать верстку/навигацию.

---

## 6. Документация и онбординг

- **API** — держать актуальным Swagger (все важные эндпоинты, примеры ответов, коды ошибок); при необходимости добавить примеры запросов для printcore.by.
- **README и env** — краткая инструкция по запуску (backend/frontend), обязательные переменные в `env.example` с комментариями (DOCUMENT_TEMPLATES_DIR, CORS_ORIGIN, JWT_SECRET и т.д.).
- **Описание бизнес-логики** — в `docs/` кратко описать статусы заказов, расчёт цен, шаблоны документов и где искать код; ссылки из README.

---

## Приоритизация (пример)

| Приоритет | Область                    | Действие                                      | Эффект                    |
|----------|----------------------------|-----------------------------------------------|---------------------------|
| Высокий  | Загрузка шаблонов          | Уже исправлено (EXDEV → copy+unlink)           | Стабильная работа на проде|
| Высокий  | N+1 в заказах              | Один запрос items по списку orderId           | Быстрее списки заказов    |
| Высокий  | Lazy loading страниц       | React.lazy для 3–5 тяжёлых страниц            | Меньший начальный бандл   |
| Средний  | Кеш PRAGMA / справочников  | tableSchemaCache + dataCache с TTL             | Меньше нагрузка на БД     |
| Средний  | Разбить крупные компоненты | PricingManagement, CustomersAdminPage         | Удобнее поддержка и тесты |
| Средний  | Переименовать index_old    | index_old.ts → index.ts                        | Меньше путаницы           |
| Низкий   | Удалить неиспользуемые     | Примеры, legacy routes, временные файлы       | Чище репозиторий          |
| Низкий   | Расширить тесты            | Критичные сервисы и API                       | Уверенность при рефакторинге |

Можно выбирать 1–2 направления за спринт и фиксировать прогресс в этом же файле или в отдельных чек-листах.
