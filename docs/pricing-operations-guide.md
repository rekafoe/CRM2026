# Управление ценами на операции

## Способы задания стоимости операций

### 1. 🎯 Базовая цена операции (простой способ)

При создании или обновлении операции через API:

```bash
POST /api/operations
{
  "name": "Цифровая печать A4",
  "operation_type": "print",
  "price": 0.10,              # ← Базовая цена за единицу
  "price_unit": "per_sheet",  # ← За что считается цена
  "setup_cost": 5,            # ← Стоимость приладки/настройки
  "min_quantity": 1           # ← Минимальный тираж
}
```

**Где применяется:**
- `price` - базовая цена за единицу (лист, изделие, м², час)
- `setup_cost` - фиксированная стоимость настройки оборудования
- `min_quantity` - минимальное количество для применения операции

**Пример расчета:**
```
Итоговая стоимость = (price × количество) + setup_cost
```

Для 100 листов печати:
```
(0.10 × 100) + 5 = 15 BYN
```

---

### 2. 🎨 Множитель для конкретного продукта

При добавлении операции к продукту можно задать индивидуальный множитель:

```bash
POST /api/products/1/operations
{
  "operation_id": 1,
  "sequence": 1,
  "price_multiplier": 1.5  # ← Цена для этого продукта будет в 1.5 раза больше
}
```

**Когда использовать:**
- Сложные материалы (толстая бумага → сложнее резать)
- Особые требования (высокая точность)
- Премиум-продукты

**Пример:**
```
Базовая цена резки: 0.01 BYN/лист
Для визиток на пластике: 0.01 × 1.5 = 0.015 BYN/лист
```

---

### 3. 📊 Правила ценообразования (гибкая система)

Таблица `operation_pricing_rules` позволяет создавать сложные правила:

#### 3.1. Скидка от тиража

```sql
INSERT INTO operation_pricing_rules (
  operation_id, 
  rule_name, 
  rule_type, 
  conditions, 
  pricing_data, 
  priority
) VALUES (
  1,  -- ID операции печати
  'Скидка от 500 листов',
  'quantity_discount',
  '{"min_quantity": 500}',
  '{"discount_percent": 10}',  -- Скидка 10%
  10
);
```

**Результат:**
- До 500 листов: 0.10 BYN/лист
- От 500 листов: 0.10 × 0.9 = 0.09 BYN/лист

#### 3.2. Надбавка за срочность

```sql
INSERT INTO operation_pricing_rules (
  operation_id, 
  rule_name, 
  rule_type, 
  conditions, 
  pricing_data, 
  priority
) VALUES (
  1,
  'Срочная печать',
  'rush',
  '{"is_rush": true}',
  '{"rush_multiplier": 1.5}',  -- Цена × 1.5
  20
);
```

**Результат:**
Если клиент выбрал срочность:
- Обычная цена: 0.10 BYN/лист
- Срочная: 0.10 × 1.5 = 0.15 BYN/лист

#### 3.3. Цена от размера

```sql
INSERT INTO operation_pricing_rules (
  operation_id, 
  rule_name, 
  rule_type, 
  conditions, 
  pricing_data, 
  priority
) VALUES (
  1,
  'Широкоформатная печать',
  'size_based',
  '{"min_width": 300, "min_height": 300}',
  '{"price_per_m2": 5.0}',
  15
);
```

#### 3.4. Цена от материала

```sql
INSERT INTO operation_pricing_rules (
  operation_id, 
  rule_name, 
  rule_type, 
  conditions, 
  pricing_data, 
  priority
) VALUES (
  3,  -- Резка
  'Резка плотных материалов',
  'material_based',
  '{"material_density": ">300"}',
  '{"material_multipliers": {"20": 1.3, "21": 1.5}}',
  12
);
```

---

### 4. 🔧 Через админку (API endpoints)

#### Обновить базовую цену:

```bash
PUT /api/operations/1
{
  "price": 0.12,
  "setup_cost": 6
}
```

#### Получить текущие цены:

```bash
GET /api/operations
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Цифровая печать",
      "price": 0.12,
      "setup_cost": 6,
      "price_unit": "per_sheet"
    }
  ]
}
```

---

## Приоритет применения цен

Система применяет цены в следующем порядке:

```
1. Базовая цена операции (price)
   ↓
2. Множитель продукта (price_multiplier)
   ↓
3. Правила ценообразования (operation_pricing_rules)
   ↓ (по приоритету: priority ASC)
4. Итоговая цена × количество + setup_cost
```

### Пример полного расчета:

**Исходные данные:**
- Операция: Цифровая печать
- Базовая цена: 0.10 BYN/лист
- Множитель продукта: 1.2 (сложный материал)
- Правило 1 (приоритет 10): Скидка 10% от 500 листов
- Правило 2 (приоритет 20): Срочность × 1.5
- Setup cost: 5 BYN
- Количество: 600 листов
- Срочность: да

**Расчет:**
```
1. Базовая цена:           0.10 BYN/лист
2. Множитель продукта:     0.10 × 1.2 = 0.12 BYN/лист
3. Правило 1 (скидка):     0.12 × 0.9 = 0.108 BYN/лист
4. Правило 2 (срочность):  0.108 × 1.5 = 0.162 BYN/лист
5. Итого за печать:        0.162 × 600 = 97.2 BYN
6. Приладка:               + 5 BYN
7. ИТОГО:                  102.2 BYN
```

---

## Практические сценарии

### Сценарий 1: Типография с гибкими скидками

```sql
-- Печать: чем больше, тем дешевле
INSERT INTO operation_pricing_rules 
  (operation_id, rule_name, rule_type, conditions, pricing_data) 
VALUES
  (1, 'До 100 листов', 'quantity_discount', '{"max_quantity": 100}', '{"discount_percent": 0}'),
  (1, '100-500 листов', 'quantity_discount', '{"min_quantity": 100, "max_quantity": 500}', '{"discount_percent": 5}'),
  (1, '500-1000 листов', 'quantity_discount', '{"min_quantity": 500, "max_quantity": 1000}', '{"discount_percent": 10}'),
  (1, 'Более 1000 листов', 'quantity_discount', '{"min_quantity": 1000}', '{"discount_percent": 15}');
```

### Сценарий 2: Разные цены для разных форматов

```sql
-- Создаем операции для каждого формата
INSERT INTO post_processing_services 
  (name, operation_type, price, price_unit, setup_cost) 
VALUES
  ('Печать A6', 'print', 0.05, 'per_sheet', 3),
  ('Печать A5', 'print', 0.08, 'per_sheet', 4),
  ('Печать A4', 'print', 0.10, 'per_sheet', 5),
  ('Печать A3', 'print', 0.15, 'per_sheet', 7),
  ('Печать SRA3', 'print', 0.18, 'per_sheet', 8);
```

### Сценарий 3: Премиум-услуги

```sql
-- Обычная ламинация
INSERT INTO post_processing_services 
  (name, operation_type, price, price_unit) 
VALUES
  ('Ламинация 75 мкм', 'laminate', 0.25, 'per_sheet');

-- Премиум ламинация
INSERT INTO post_processing_services 
  (name, operation_type, price, price_unit) 
VALUES
  ('Ламинация soft-touch', 'laminate', 0.45, 'per_sheet');
```

---

## API для управления правилами ценообразования

### Создать правило (будущий endpoint):

```bash
POST /api/operations/1/pricing-rules
{
  "rule_name": "Скидка от 1000 листов",
  "rule_type": "quantity_discount",
  "conditions": {
    "min_quantity": 1000
  },
  "pricing_data": {
    "discount_percent": 15
  },
  "priority": 10,
  "is_active": true
}
```

### Получить правила операции:

```bash
GET /api/operations/1/pricing-rules
```

---

## Интерфейс админки (концепт)

### Страница редактирования операции:

```
╔══════════════════════════════════════════════════╗
║ Редактирование операции: Цифровая печать        ║
╠══════════════════════════════════════════════════╣
║                                                  ║
║  Название: [Цифровая печать A4            ]     ║
║  Тип: [print ▼]                                  ║
║  Базовая цена: [0.10] BYN за [per_sheet ▼]      ║
║  Стоимость приладки: [5] BYN                     ║
║  Минимальный тираж: [1] листов                   ║
║                                                  ║
║  ┌─────────────────────────────────────────┐    ║
║  │ Правила ценообразования          [+ Добавить]│    ║
║  ├─────────────────────────────────────────┤    ║
║  │ ☑ Скидка от 500 листов (-10%)          │    ║
║  │ ☑ Скидка от 1000 листов (-15%)         │    ║
║  │ ☑ Надбавка за срочность (+50%)         │    ║
║  └─────────────────────────────────────────┘    ║
║                                                  ║
║  [Сохранить]  [Отмена]                          ║
╚══════════════════════════════════════════════════╝
```

---

## Рекомендации

### ✅ Лучшие практики:

1. **Начните с базовых цен** - задайте простую цену для каждой операции
2. **Добавляйте правила постепенно** - сначала скидки от тиража, потом более сложные
3. **Используйте приоритеты** - меньшее число = выше приоритет
4. **Тестируйте расчеты** - проверяйте результаты через `/api/products/:id/calculate`
5. **Документируйте правила** - добавляйте понятные `rule_name`

### ⚠️ Чего избегать:

1. Не создавайте противоречивые правила
2. Не делайте слишком сложную логику с условиями
3. Не забывайте про `is_active` - можно временно отключить правило
4. Проверяйте границы тиражей (min/max_quantity)

---

## Миграция с хардкода на БД

Если у вас были хардкоженные цены, вот как их перенести:

### Было (в коде):
```typescript
const PRICES = {
  print_a4: 0.10,
  lamination: 0.25,
  cutting: 0.01
};
```

### Стало (в БД):
```sql
INSERT INTO post_processing_services 
  (name, operation_type, price, price_unit) 
VALUES
  ('Печать A4', 'print', 0.10, 'per_sheet'),
  ('Ламинация', 'laminate', 0.25, 'per_sheet'),
  ('Резка', 'cut', 0.01, 'per_sheet');
```

---

## Дальнейшее развитие

### Планируется добавить:

1. **API для правил ценообразования**
   - `POST /api/operations/:id/pricing-rules`
   - `PUT /api/operations/:id/pricing-rules/:ruleId`
   - `DELETE /api/operations/:id/pricing-rules/:ruleId`

2. **Массовое обновление цен**
   - `POST /api/operations/bulk-update-prices`
   - Импорт из Excel/CSV

3. **История изменения цен**
   - Логирование всех изменений
   - Откат к предыдущим ценам

4. **Сезонные цены**
   - Автоматическое изменение цен по расписанию
   - Акции и специальные предложения

5. **Интеграция с внешними системами**
   - Синхронизация цен с поставщиками
   - API для получения текущих расценок

---

**Текущий статус:** Базовая система работает, добавляйте цены через API! 🚀


