# Руководство по настройке условных операций

## 🎯 Что такое условные операции?

**Условные операции** - это операции, которые применяются в расчете цены только при определенных условиях, например:
- **Цветная печать** - только когда клиент выбрал "Цветная"
- **Ч/Б печать** - только когда клиент выбрал "Черно-белая"
- **Ламинация** - только когда клиент поставил галочку "Ламинирование"

---

## 🆕 Новый улучшенный интерфейс

На странице шаблона продукта (`/adminpanel/products/:id/template`) теперь доступна секция **"Операции и расчет цены"**.

### 📍 Где находится:
**Вкладка**: "Основные настройки"  
**Секция**: "Операции и расчет цены" (после "Параметры продукта")

---

## 🎨 Интерфейс секции операций

```
┌────────────────────────────────────────────────────────────────┐
│ ⚙️ Операции и расчет цены                                     │
│ Настройте операции для расчета стоимости                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ # │ Операция               │ Тип   │ Цена      │ Условие     │
│───┼────────────────────────┼───────┼───────────┼─────────────│
│ 1 │ Резка на гильотине     │ cut   │ 1.00/рез  │ ✓ Всегда    │
│   │                        │       │           │ ✅ Обяз.    │
│   │                        │       │           │ [⚙️][🗑️]   │
│───┼────────────────────────┼───────┼───────────┼─────────────│
│ 2 │ Цифровая цветная печать│ print │ 0.25/лист │ 🔀 Условная │
│   │ 🔀 print_method = Цветная      │           │ ✅ Обяз.    │
│   │                        │       │           │ [⚙️][🗑️]   │
│───┼────────────────────────┼───────┼───────────┼─────────────│
│ 3 │ Цифровая ч/б печать    │ print │ 0.11/лист │ 🔀 Условная │
│   │ 🔀 print_method = Ч/Б          │           │ ✅ Обяз.    │
│   │                        │       │           │ [⚙️][🗑️]   │
└────────────────────────────────────────────────────────────────┘

[+ Добавить операцию]  [📦 Массовое добавление]
```

---

## ⚙️ Настройка условной операции

### Шаг 1: Нажать "⚙️ Настроить"

Откроется модальное окно:

```
┌──────────────────────────────────────────────────────────┐
│ Настройка операции: Цифровая цветная печать        [×]  │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ Операция: Цифровая цветная печать                       │
│ Тип: print                                               │
│ Цена: 0.25 BYN за per_sheet                             │
│                                                          │
│ ── Когда применять операцию? ──                         │
│                                                          │
│ ○ ✅ Всегда                                             │
│   Операция применяется для всех заказов                 │
│                                                          │
│ ● 🔀 Условно (по параметру)                             │
│   Операция применяется только при определенном          │
│   значении параметра                                    │
│                                                          │
│   ┌────────────────────────────────────────────────┐    │
│   │ ℹ️ Условная операция                           │    │
│   │ Операция будет добавлена в расчет только       │    │
│   │ когда клиент выберет указанное значение        │    │
│   └────────────────────────────────────────────────┘    │
│                                                          │
│   Параметр, от которого зависит операция:               │
│   ┌────────────────────────────────────────────────┐    │
│   │ Печать                                    ▼   │    │
│   │   • Печать                                     │    │
│   │   • Материал                                   │    │
│   │   • Плотность                                  │    │
│   └────────────────────────────────────────────────┘    │
│                                                          │
│   Значение параметра, при котором применяется:          │
│   ┌────────────────────────────────────────────────┐    │
│   │ Двусторонняя цветная              ▼          │    │
│   │   • Односторонняя цветная                     │    │
│   │   • Двусторонняя цветная                      │    │
│   │   • Цифровая премиум                          │    │
│   │   • Офсетная                                  │    │
│   └────────────────────────────────────────────────┘    │
│                                                          │
│   ┌────────────────────────────────────────────────┐    │
│   │ ✅ Условие настроено                           │    │
│   │ Операция "Цифровая цветная печать" будет      │    │
│   │ применена, когда "Печать" = "Двусторонняя     │    │
│   │ цветная"                                       │    │
│   └────────────────────────────────────────────────┘    │
│                                                          │
│ ── Обязательность операции ──                           │
│                                                          │
│ ☑ Обязательная операция                                 │
│ ✅ Операция всегда включается в расчет                   │
│    (если выполняются условия)                           │
│                                                          │
│                        [Отмена]  [💾 Сохранить]         │
└──────────────────────────────────────────────────────────┘
```

---

## 📝 Пример настройки для продукта 58

### Проблема: 
Обе операции печати (цветная И ч/б) применяются одновременно, завышая стоимость.

### Решение:

#### 1. **Создать/проверить параметр выбора типа печати**

Секция "Параметры продукта":
```
Параметр: print_method
Тип: select
Опции: Односторонняя цветная; Двусторонняя цветная; Цифровая премиум; Офсетная
```

✅ У продукта 58 этот параметр уже есть!

#### 2. **Настроить условие для цветной печати**

1. Найти операцию "Цифровая цветная печать (SRA3)"
2. Нажать **"⚙️ Настроить"**
3. Выбрать:
   - Режим: **🔀 Условно (по параметру)**
   - Параметр: **print_method** (Печать)
   - Значение: **Двусторонняя цветная** (или любое с "цветн")
4. Оставить: **☑ Обязательная операция**
5. Нажать **"💾 Сохранить"**

#### 3. **Настроить условие для Ч/Б печати**

1. Найти операцию "Цифровая ч/б печать (SRA3)"
2. Нажать **"⚙️ Настроить"**
3. Выбрать:
   - Режим: **🔀 Условно (по параметру)**
   - Параметр: **print_method** (Печать)
   - Значение: **Офсетная** (или создать новый вариант "Ч/Б")
4. Оставить: **☑ Обязательная операция**
5. Нажать **"💾 Сохранить"**

---

## 🎯 Результат

### После настройки условий:

```
Операции продукта 58:

1. Резка на гильотине
   Условие: ✓ Всегда
   Статус: ✅ Обязательная
   
2. Цифровая цветная печать
   Условие: 🔀 print_method = Двусторонняя цветная
   Статус: ✅ Обязательная
   
3. Цифровая ч/б печать
   Условие: 🔀 print_method = Офсетная
   Статус: ✅ Обязательная
```

### В калькуляторе для клиента:

**Когда клиент выбирает**:
```
Печать: [Двусторонняя цветная ▼]
```

**Применяются операции**:
- ✅ Резка (всегда)
- ✅ Цифровая цветная печать (условие выполнено)
- ❌ Цифровая ч/б печать (условие НЕ выполнено)

**Расчет**:
```
Материалы:  37.50 BYN
Операции:   17.50 BYN  ← Только резка + цветная!
  • Резка:   5.00 BYN
  • Цветная: 12.50 BYN
Setup:       5.00 BYN
────────────────────
ИТОГО:      60.00 BYN
```

---

## 💡 Примеры использования условных операций

### Пример 1: Ламинация (checkbox)

**Параметр**:
```
name: lamination
type: checkbox
label: Ламинирование
```

**Операция**:
```
Название: Ламинация глянцевая
Условие: lamination = true (когда включено)
```

**Результат**: Ламинация добавляется только когда клиент поставил галочку.

---

### Пример 2: Скругление углов (checkbox)

**Параметр**:
```
name: round_corners
type: checkbox
label: Скругление углов
```

**Операция**:
```
Название: Скругление углов
Условие: round_corners = true
```

---

### Пример 3: Тип переплета (select)

**Параметр**:
```
name: binding
type: select
options: Скрепка; Пружина; Клеевое скрепление
```

**Операции**:
```
1. Скрепление скобой
   Условие: binding = Скрепка
   
2. Переплет на пружину
   Условие: binding = Пружина
   
3. КБС (клеевое)
   Условие: binding = Клеевое скрепление
```

**Результат**: Применяется только выбранный тип переплета.

---

## 🔧 Технические детали

### Что сохраняется в БД:

```sql
-- Таблица: product_operations_link

UPDATE product_operations_link SET
  is_required = 1,                           -- Обязательная
  linked_parameter_name = 'print_method',   -- Параметр
  conditions = '{"print_method": "Двусторонняя цветная"}',  -- Условие
  updated_at = datetime('now')
WHERE id = 2 AND product_id = 58;
```

### Как проверяются условия:

**Код**: `FlexiblePricingService.checkConditions()` (строки 394-404)

```typescript
// При расчете цены:
configuration = {
  material_id: 44,
  print_method: 'Двусторонняя цветная'
}

// Для операции:
conditions = { print_method: 'Двусторонняя цветная' }

// Проверка:
configuration.print_method === conditions.print_method
// true → операция применяется ✅
```

---

## ✅ Преимущества нового интерфейса:

1. **Визуальная настройка** - не нужно писать JSON вручную
2. **Выбор из параметров** - не нужно помнить названия
3. **Предпросмотр условия** - видно, что настроено
4. **Валидация** - нельзя сохранить без выбора значения
5. **Понятные индикаторы** - видно сразу, какие операции условные

---

## 🎯 Быстрый старт: Исправление продукта 58

### Шаг 1: Открыть страницу
```
http://localhost:5173/adminpanel/products/58/template
```

### Шаг 2: Прокрутить до секции "Операции и расчет цены"

### Шаг 3: Настроить цветную печать
1. Найти "Цифровая цветная печать (SRA3)"
2. Нажать **"⚙️ Настроить"**
3. Выбрать:
   - ○ Всегда → **● Условно**
   - Параметр: **print_method**
   - Значение: **Двусторонняя цветная**
4. Нажать **"💾 Сохранить"**

### Шаг 4: Настроить ч/б печать
1. Найти "Цифровая ч/б печать (SRA3)"
2. Нажать **"⚙️ Настроить"**
3. Выбрать:
   - ○ Всегда → **● Условно**
   - Параметр: **print_method**
   - Значение: **Односторонняя цветная** (или добавить вариант "Ч/Б")
4. Нажать **"💾 Сохранить"**

### Шаг 5: Проверить в Quick Test
1. В правой панели найти "🧪 Быстрый тест цены"
2. Выбрать **Печать: Двусторонняя цветная**
3. Нажать **"🧮 Рассчитать"**
4. Должна применяться только цветная печать ✅

---

## 📊 Ожидаемый результат

### До настройки условий:
```
Операции: 68.00 BYN
  • Резка: 50.00 BYN  ❌ (per_sheet - неправильно)
  • Цветная: 12.50 BYN
  • Ч/Б: 5.50 BYN  ❌ (лишняя)
```

### После настройки условий и исправления резки:
```
Операции: 17.50 BYN  ✅
  • Резка: 5.00 BYN  ✅ (per_cut - правильно, 5 резов)
  • Цветная: 12.50 BYN  ✅ (условие выполнено)
```

**Экономия**: 50.50 BYN на каждом заказе! 🎉

---

## 🎯 Типичные сценарии

### Сценарий 1: Выбор типа печати (самый частый)

**Параметры**:
- `print_method` (select): Цветная, Ч/Б, Офсетная

**Операции**:
- Цветная печать → условие: `print_method = Цветная`
- Ч/Б печать → условие: `print_method = Ч/Б`
- Офсетная печать → условие: `print_method = Офсетная`

---

### Сценарий 2: Дополнительные услуги (checkbox)

**Параметры**:
- `lamination` (checkbox): Ламинирование
- `round_corners` (checkbox): Скругление углов

**Операции**:
- Ламинация → условие: `lamination = true`
- Скругление → условие: `round_corners = true`

---

### Сценарий 3: Тип переплета (select)

**Параметры**:
- `binding` (select): Скрепка, Пружина, КБС, Без переплета

**Операции**:
- Скрепление → условие: `binding = Скрепка`
- Пружина → условие: `binding = Пружина`
- КБС → условие: `binding = КБС`

---

## ⚠️ Важные замечания

### 1. **Сначала параметр, потом операция**
Перед настройкой условной операции убедитесь, что параметр создан в секции "Параметры продукта".

### 2. **Точное совпадение значений**
Значение в условии должно **точно совпадать** с опцией параметра:
- ✅ `print_method = "Двусторонняя цветная"` (как в параметре)
- ❌ `print_method = "Цветная"` (не совпадает)

### 3. **Для checkbox используйте true/false**
- Когда включено: `true`
- Когда выключено: `false`

### 4. **Обязательность vs Условность**
- **Обязательная** = всегда включается (если условие выполнено)
- **Опциональная** = может быть выключена клиентом

---

## ✨ Заключение

Теперь у вас есть **удобный графический интерфейс** для настройки условных операций!

**Ключевые улучшения**:
- ✅ Визуальная настройка условий
- ✅ Выбор параметра из списка
- ✅ Предпросмотр настройки
- ✅ Индикаторы в таблице операций
- ✅ Понятные подсказки

**Результат**: Клиенты видят правильную цену в зависимости от выбранных опций! 🎉

