# Интеграция заказов с сайта (по примеру karandash.by)

Ответы на вопросы по API пула заказов и созданию заказов с сайта.

---

## 1. Как API Order Pool позволяют отправлять заказы с сайта в него?

Заказы с сайта **не «отправляются» отдельно в пул** — они попадают в пул автоматически.

**Схема:**

1. **Создание заказа с сайта**  
   Заказ создаётся через API (см. п. 3) и сохраняется в таблицу `orders` с полем `source = 'website'` и без менеджера (`userId = null`).

2. **Пул заказов**  
   Эндпоинт **`GET /api/order-management/pool`** отдаёт три списка:
   - **unassigned** — заказы без назначения (в т.ч. с сайта со статусом «ожидает»);
   - **assigned** — заказы, уже назначенные на страницу менеджера;
   - **completed** — завершённые.

   В пул попадают заказы из:
   - **Telegram:** таблица `photo_orders` (status = pending / ready_for_approval);
   - **Сайт:** таблица `orders` с **`source = 'website'`** и **`status = 1`** (первый статус, обычно «Ожидает» / «Новый»).

3. **Назначение заказа менеджеру**  
   Менеджер в CRM выбирает заказ из пула и назначает его себе:
   - **`POST /api/order-management/assign`**  
     Body: `{ orderId, orderType: 'website', userId, userName, date }`.  
   В результате создаётся запись в `user_order_page_orders`, заказ переходит в «assigned» и при необходимости обновляется статус (например, на «в работе»).

**Итог:** заказы с сайта оказываются в пуле, если они созданы с `source: 'website'` и имеют статус 1; дальше они отображаются в «Пул заказов» и назначаются через `POST /api/order-management/assign`.

---

## 2. Как лучше хранить заказы с сайта, которые ещё не назначены?

**Рекомендуемый вариант (как сейчас):** одна таблица **`orders`** для всех заказов.

- Заказы с сайта — те же строки в `orders`, с отличиями:
  - **`source = 'website'`**
  - **`userId = NULL`** (никому не назначен)
  - **`status`** = первый статус (обычно id = 1, «Ожидает» / «Новый»)

Назначение «кто взял заказ» хранится отдельно в **`user_order_page_orders`** (связь заказа со страницей заказов менеджера). До назначения запись в этой таблице отсутствует — такие заказы и считаются «не назначенными» и попадают в **unassigned** в пуле.

**Плюсы такого хранения:**

- Один источник правды для заказов (сайт, CRM, Telegram — все в `orders`).
- Фильтры по `source`, `userId`, `status` и отчёты работают единообразно.
- Пул заказов просто выбирает из `orders` заказы с `source = 'website'` и `status = 1` и проверяет отсутствие записи в `user_order_page_orders`.

Отдельная таблица только «для заказов с сайта» не нужна — усложнит отчёты и дублирование логики.

---

## 3. Какой API отвечает за создание заказа через сайт?

**Основной вариант (с авторизацией):**

- **`POST /api/orders`**  
  - Требуется **аутентификация** (Bearer / сессия).  
  - Body может содержать: `customerName`, `customerPhone`, `customerEmail`, `prepaymentAmount`, `date`, `customer_id`.  
  - Сейчас контроллер **не передаёт в сервис поле `source`** — заказ создаётся как `source = 'crm'`. Чтобы заказы с сайта шли в пул и помечались как сайтовые, нужно либо:
  - добавить в body параметр **`source: 'website'`** и пробросить его в `OrderService.createOrder(..., source)`; либо  
  - завести отдельный эндпоинт для сайта (см. ниже).

**Публичный эндпоинт для сайта (реализован):**

- **`POST /api/orders/from-website`** — создание заказа с сайта без авторизации в CRM.
- **Авторизация:** заголовок **`X-API-Key`** или **`Authorization: Bearer <key>`**. Ключ задаётся в env: **`WEBSITE_ORDER_API_KEY`**. Если переменная не задана — эндпоинт возвращает 503.
- **Body (JSON):**
  - `customerName`, `customerPhone`, `customerEmail` (опционально), `prepaymentAmount` (опционально), `customer_id` (опционально).
  - Обязательно: **`customerName`** или **`customerPhone`**.
  - Опционально: **`items`** — массив позиций заказа (как в `POST /api/orders/with-auto-deduction`). Если передан непустой массив — заказ создаётся с позициями и автоматическим списанием материалов; иначе создаётся пустой заказ.
- Заказ создаётся с **`source = 'website'`**, **`userId = null`** и попадает в пул заказов (unassigned).

---

## Краткая схема для интеграции типа karandash.by

1. **Сайт** при оформлении заказа вызывает API создания заказа (после появления публичного эндпоинта или с API-ключом), с `source: 'website'`, без `userId`.
2. Заказ сохраняется в **`orders`** (`source = 'website'`, `userId = null`, `status = 1`).
3. В CRM в разделе **«Пул заказов»** запрос **`GET /api/order-management/pool`** подтягивает эти заказы в блок **unassigned**.
4. Менеджер нажимает «Взять» → **`POST /api/order-management/assign`** с `orderType: 'website'` и своими `userId`, `userName`, `date`.
5. Заказ появляется на странице заказов менеджера и уходит из unassigned.

Если нужно, могу предложить конкретные изменения в коде (роут, контроллер, проверка API-ключа) для публичного создания заказов с сайта.
